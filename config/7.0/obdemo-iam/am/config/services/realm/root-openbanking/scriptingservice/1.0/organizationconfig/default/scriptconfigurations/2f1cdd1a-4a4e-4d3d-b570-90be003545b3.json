{
  "metadata" : {
    "realm" : "/openbanking",
    "entityType" : "ScriptingService",
    "entityId" : "default/scriptConfigurations/2f1cdd1a-4a4e-4d3d-b570-90be003545b3",
    "uid" : "ou=2f1cdd1a-4a4e-4d3d-b570-90be003545b3,ou=scriptConfigurations,ou=default,ou=OrganizationConfig,ou=1.0,ou=ScriptingService,ou=services,o=openbanking,ou=services,ou=am-config",
    "sunServiceID" : "scriptConfiguration",
    "objectClass" : [ "top", "sunServiceComponent" ],
    "pathParams" : { },
    "ou" : [ "2f1cdd1a-4a4e-4d3d-b570-90be003545b3" ]
  },
  "data" : {
    "_id" : "default/scriptConfigurations/2f1cdd1a-4a4e-4d3d-b570-90be003545b3",
    "_type" : {
      "_id" : "ScriptingService",
      "name" : "ScriptingService",
      "collection" : false
    },
    "createdBy" : "null",
    "lastModifiedDate" : "0",
    "lastModifiedBy" : "null",
    "name" : "Open Banking Dynamic Policy",
    "context" : "POLICY_CONDITION",
    "description" : null,
    "language" : "JAVASCRIPT",
    "creationDate" : "0",
    "script" : "U1RBVFVTX0FVVEhPUklTRUQgPSAiQXV0aG9yaXNlZCIKCgoKbG9nZ2VyLmVycm9yKCJPQl9Qb2xpY3kgc3RhcnRpbmciKQoKLy8gVE9ETzogaGFzaCBpbnN0ZWFkIG9mIGNvbnRlbnQKdmFyIHNoYTI1NiA9IGZ1bmN0aW9uIHNoYTI1Nihhc2NpaSkgewogICAgZnVuY3Rpb24gcmlnaHRSb3RhdGUodmFsdWUsIGFtb3VudCkgewogICAgICAgIHJldHVybiAodmFsdWU+Pj5hbW91bnQpIHwgKHZhbHVlPDwoMzIgLSBhbW91bnQpKTsKICAgIH07CiAgICAKICAgIHZhciBtYXRoUG93ID0gTWF0aC5wb3c7CiAgICB2YXIgbWF4V29yZCA9IG1hdGhQb3coMiwgMzIpOwogICAgdmFyIGxlbmd0aFByb3BlcnR5ID0gJ2xlbmd0aCcKICAgIHZhciBpLCBqOyAvLyBVc2VkIGFzIGEgY291bnRlciBhY3Jvc3MgdGhlIHdob2xlIGZpbGUKICAgIHZhciByZXN1bHQgPSAnJwoKICAgIHZhciB3b3JkcyA9IFtdOwogICAgdmFyIGFzY2lpQml0TGVuZ3RoID0gYXNjaWlbbGVuZ3RoUHJvcGVydHldKjg7CiAgICAKICAgIC8vKiBjYWNoaW5nIHJlc3VsdHMgaXMgb3B0aW9uYWwgLSByZW1vdmUvYWRkIHNsYXNoIGZyb20gZnJvbnQgb2YgdGhpcyBsaW5lIHRvIHRvZ2dsZQogICAgLy8gSW5pdGlhbCBoYXNoIHZhbHVlOiBmaXJzdCAzMiBiaXRzIG9mIHRoZSBmcmFjdGlvbmFsIHBhcnRzIG9mIHRoZSBzcXVhcmUgcm9vdHMgb2YgdGhlIGZpcnN0IDggcHJpbWVzCiAgICAvLyAod2UgYWN0dWFsbHkgY2FsY3VsYXRlIHRoZSBmaXJzdCA2NCwgYnV0IGV4dHJhIHZhbHVlcyBhcmUganVzdCBpZ25vcmVkKQogICAgdmFyIGhhc2ggPSBzaGEyNTYuaCA9IHNoYTI1Ni5oIHx8IFtdOwogICAgLy8gUm91bmQgY29uc3RhbnRzOiBmaXJzdCAzMiBiaXRzIG9mIHRoZSBmcmFjdGlvbmFsIHBhcnRzIG9mIHRoZSBjdWJlIHJvb3RzIG9mIHRoZSBmaXJzdCA2NCBwcmltZXMKICAgIHZhciBrID0gc2hhMjU2LmsgPSBzaGEyNTYuayB8fCBbXTsKICAgIHZhciBwcmltZUNvdW50ZXIgPSBrW2xlbmd0aFByb3BlcnR5XTsKICAgIC8qLwogICAgdmFyIGhhc2ggPSBbXSwgayA9IFtdOwogICAgdmFyIHByaW1lQ291bnRlciA9IDA7CiAgICAvLyovCgogICAgdmFyIGlzQ29tcG9zaXRlID0ge307CiAgICBmb3IgKHZhciBjYW5kaWRhdGUgPSAyOyBwcmltZUNvdW50ZXIgPCA2NDsgY2FuZGlkYXRlKyspIHsKICAgICAgICBpZiAoIWlzQ29tcG9zaXRlW2NhbmRpZGF0ZV0pIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDMxMzsgaSArPSBjYW5kaWRhdGUpIHsKICAgICAgICAgICAgICAgIGlzQ29tcG9zaXRlW2ldID0gY2FuZGlkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhhc2hbcHJpbWVDb3VudGVyXSA9IChtYXRoUG93KGNhbmRpZGF0ZSwgLjUpKm1heFdvcmQpfDA7CiAgICAgICAgICAgIGtbcHJpbWVDb3VudGVyKytdID0gKG1hdGhQb3coY2FuZGlkYXRlLCAxLzMpKm1heFdvcmQpfDA7CiAgICAgICAgfQogICAgfQogICAgCiAgICBhc2NpaSArPSAnXHg4MCcgLy8gQXBwZW5kIMaHJyBiaXQgKHBsdXMgemVybyBwYWRkaW5nKQogICAgd2hpbGUgKGFzY2lpW2xlbmd0aFByb3BlcnR5XSU2NCAtIDU2KSBhc2NpaSArPSAnXHgwMCcgLy8gTW9yZSB6ZXJvIHBhZGRpbmcKICAgIGZvciAoaSA9IDA7IGkgPCBhc2NpaVtsZW5ndGhQcm9wZXJ0eV07IGkrKykgewogICAgICAgIGogPSBhc2NpaS5jaGFyQ29kZUF0KGkpOwogICAgICAgIGlmIChqPj44KSByZXR1cm47IC8vIEFTQ0lJIGNoZWNrOiBvbmx5IGFjY2VwdCBjaGFyYWN0ZXJzIGluIHJhbmdlIDAtMjU1CiAgICAgICAgd29yZHNbaT4+Ml0gfD0gaiA8PCAoKDMgLSBpKSU0KSo4OwogICAgfQogICAgd29yZHNbd29yZHNbbGVuZ3RoUHJvcGVydHldXSA9ICgoYXNjaWlCaXRMZW5ndGgvbWF4V29yZCl8MCk7CiAgICB3b3Jkc1t3b3Jkc1tsZW5ndGhQcm9wZXJ0eV1dID0gKGFzY2lpQml0TGVuZ3RoKQogICAgCiAgICAvLyBwcm9jZXNzIGVhY2ggY2h1bmsKICAgIGZvciAoaiA9IDA7IGogPCB3b3Jkc1tsZW5ndGhQcm9wZXJ0eV07KSB7CiAgICAgICAgdmFyIHcgPSB3b3Jkcy5zbGljZShqLCBqICs9IDE2KTsgLy8gVGhlIG1lc3NhZ2UgaXMgZXhwYW5kZWQgaW50byA2NCB3b3JkcyBhcyBwYXJ0IG9mIHRoZSBpdGVyYXRpb24KICAgICAgICB2YXIgb2xkSGFzaCA9IGhhc2g7CiAgICAgICAgLy8gVGhpcyBpcyBub3cgdGhlIHVuZGVmaW5lZHdvcmtpbmcgaGFzaCIsIG9mdGVuIGxhYmVsbGVkIGFzIHZhcmlhYmxlcyBhLi4uZwogICAgICAgIC8vICh3ZSBoYXZlIHRvIHRydW5jYXRlIGFzIHdlbGwsIG90aGVyd2lzZSBleHRyYSBlbnRyaWVzIGF0IHRoZSBlbmQgYWNjdW11bGF0ZQogICAgICAgIGhhc2ggPSBoYXNoLnNsaWNlKDAsIDgpOwogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCA2NDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBpMiA9IGkgKyBqOwogICAgICAgICAgICAvLyBFeHBhbmQgdGhlIG1lc3NhZ2UgaW50byA2NCB3b3JkcwogICAgICAgICAgICAvLyBVc2VkIGJlbG93IGlmIAogICAgICAgICAgICB2YXIgdzE1ID0gd1tpIC0gMTVdLCB3MiA9IHdbaSAtIDJdOwoKICAgICAgICAgICAgLy8gSXRlcmF0ZQogICAgICAgICAgICB2YXIgYSA9IGhhc2hbMF0sIGUgPSBoYXNoWzRdOwogICAgICAgICAgICB2YXIgdGVtcDEgPSBoYXNoWzddCiAgICAgICAgICAgICAgICArIChyaWdodFJvdGF0ZShlLCA2KSBeIHJpZ2h0Um90YXRlKGUsIDExKSBeIHJpZ2h0Um90YXRlKGUsIDI1KSkgLy8gUzEKICAgICAgICAgICAgICAgICsgKChlJmhhc2hbNV0pXigofmUpJmhhc2hbNl0pKSAvLyBjaAogICAgICAgICAgICAgICAgKyBrW2ldCiAgICAgICAgICAgICAgICAvLyBFeHBhbmQgdGhlIG1lc3NhZ2Ugc2NoZWR1bGUgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICArICh3W2ldID0gKGkgPCAxNikgPyB3W2ldIDogKAogICAgICAgICAgICAgICAgICAgICAgICB3W2kgLSAxNl0KICAgICAgICAgICAgICAgICAgICAgICAgKyAocmlnaHRSb3RhdGUodzE1LCA3KSBeIHJpZ2h0Um90YXRlKHcxNSwgMTgpIF4gKHcxNT4+PjMpKSAvLyBzMAogICAgICAgICAgICAgICAgICAgICAgICArIHdbaSAtIDddCiAgICAgICAgICAgICAgICAgICAgICAgICsgKHJpZ2h0Um90YXRlKHcyLCAxNykgXiByaWdodFJvdGF0ZSh3MiwgMTkpIF4gKHcyPj4+MTApKSAvLyBzMQogICAgICAgICAgICAgICAgICAgICl8MAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgLy8gVGhpcyBpcyBvbmx5IHVzZWQgb25jZSwgc28gKmNvdWxkKiBiZSBtb3ZlZCBiZWxvdywgYnV0IGl0IG9ubHkgc2F2ZXMgNCBieXRlcyBhbmQgbWFrZXMgdGhpbmdzIHVucmVhZGJsZQogICAgICAgICAgICB2YXIgdGVtcDIgPSAocmlnaHRSb3RhdGUoYSwgMikgXiByaWdodFJvdGF0ZShhLCAxMykgXiByaWdodFJvdGF0ZShhLCAyMikpIC8vIFMwCiAgICAgICAgICAgICAgICArICgoYSZoYXNoWzFdKV4oYSZoYXNoWzJdKV4oaGFzaFsxXSZoYXNoWzJdKSk7IC8vIG1hagogICAgICAgICAgICAKICAgICAgICAgICAgaGFzaCA9IFsodGVtcDEgKyB0ZW1wMil8MF0uY29uY2F0KGhhc2gpOyAvLyBXZSBkb24ndCBib3RoZXIgdHJpbW1pbmcgb2ZmIHRoZSBleHRyYSBvbmVzLCB0aGV5J3JlIGhhcm1sZXNzIGFzIGxvbmcgYXMgd2UncmUgdHJ1bmNhdGluZyB3aGVuIHdlIGRvIHRoZSBzbGljZSgpCiAgICAgICAgICAgIGhhc2hbNF0gPSAoaGFzaFs0XSArIHRlbXAxKXwwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgICAgIGhhc2hbaV0gPSAoaGFzaFtpXSArIG9sZEhhc2hbaV0pfDA7CiAgICAgICAgfQogICAgfQogICAgCiAgICBmb3IgKGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgZm9yIChqID0gMzsgaiArIDE7IGotLSkgewogICAgICAgICAgICB2YXIgYiA9IChoYXNoW2ldPj4oaio4KSkmMjU1OwogICAgICAgICAgICByZXN1bHQgKz0gKChiIDwgMTYpID8gMCA6ICcnKSArIGIudG9TdHJpbmcoMTYpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7Cn07CgpmdW5jdGlvbiBoZXgyYmluKGhleCkgewogIHZhciBieXRlcyA9IFtdCiAgZm9yKHZhciBpPTA7IGk8IGhleC5sZW5ndGgtMTsgaSs9Mil7CiAgICBieXRlcy5wdXNoKHBhcnNlSW50KGhleC5zdWJzdHIoaSwgMiksIDE2KSk7CiAgfQogIHJldHVybiBieXRlcwogIAp9CgpmdW5jdGlvbiBwYXJzZVJlc291cmNlVXJpKCkgewogIHZhciBlbGVtZW50cyA9IHJlc291cmNlVVJJLnNwbGl0KCIvIik7CiAgcmV0dXJuIHsKICAgICJhcGkiOiBlbGVtZW50c1s1XSwKICAgICJhY2NvdW50IjogKGVsZW1lbnRzLmxlbmd0aCA+IDYpID8gZWxlbWVudHNbNl0gOiBudWxsLAogICAgImRhdGEiIDogKGVsZW1lbnRzLmxlbmd0aCA+IDcpID8gZWxlbWVudHNbN10gOiBudWxsCiAgfQp9CgoKCgl2YXIgcD0iPSI7Cgl2YXIgdGFiPSJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvIjsKCglmdW5jdGlvbiBiYXNlNjRlbmNvZGUoLyogYnl0ZVtdICovYmEpewoJCS8vCXN1bW1hcnkKCQkvLwlFbmNvZGUgYW4gYXJyYXkgb2YgYnl0ZXMgYXMgYSBiYXNlNjQtZW5jb2RlZCBzdHJpbmcKCQl2YXIgcz1bXSwgbD1iYS5sZW5ndGg7CgkJdmFyIHJtPWwlMzsKCQl2YXIgeD1sLXJtOwoJCWZvciAodmFyIGk9MDsgaTx4Oyl7CgkJCXZhciB0PWJhW2krK108PDE2fGJhW2krK108PDh8YmFbaSsrXTsKCQkJcy5wdXNoKHRhYi5jaGFyQXQoKHQ+Pj4xOCkmMHgzZikpOwoJCQlzLnB1c2godGFiLmNoYXJBdCgodD4+PjEyKSYweDNmKSk7CgkJCXMucHVzaCh0YWIuY2hhckF0KCh0Pj4+NikmMHgzZikpOwoJCQlzLnB1c2godGFiLmNoYXJBdCh0JjB4M2YpKTsKCQl9CgkJLy8JZGVhbCB3aXRoIHRyYWlsZXJzLCBiYXNlZCBvbiBwYXRjaCBmcm9tIFBldGVyIFdvb2QuCgkJc3dpdGNoKHJtKXsKCQkJY2FzZSAyOnsKCQkJCXZhciB0PWJhW2krK108PDE2fGJhW2krK108PDg7CgkJCQlzLnB1c2godGFiLmNoYXJBdCgodD4+PjE4KSYweDNmKSk7CgkJCQlzLnB1c2godGFiLmNoYXJBdCgodD4+PjEyKSYweDNmKSk7CgkJCQlzLnB1c2godGFiLmNoYXJBdCgodD4+PjYpJjB4M2YpKTsKCQkJCXMucHVzaChwKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgMTp7CgkJCQl2YXIgdD1iYVtpKytdPDwxNjsKCQkJCXMucHVzaCh0YWIuY2hhckF0KCh0Pj4+MTgpJjB4M2YpKTsKCQkJCXMucHVzaCh0YWIuY2hhckF0KCh0Pj4+MTIpJjB4M2YpKTsKCQkJCXMucHVzaChwKTsKCQkJCXMucHVzaChwKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiBzLmpvaW4oIiIpOwkvLwlzdHJpbmcKCX0KCmZ1bmN0aW9uIGJhc2U2NGRlY29kZSgvKiBzdHJpbmcgKi9zdHIpewoJCS8vCXN1bW1hcnkKCQkvLwlDb252ZXJ0IGEgYmFzZTY0LWVuY29kZWQgc3RyaW5nIHRvIGFuIGFycmF5IG9mIGJ5dGVzCgkJdmFyIHM9c3RyLnNwbGl0KCIiKSwgb3V0PVtdOwoJCXZhciBsPXMubGVuZ3RoOwoJCXdoaWxlKHNbLS1sXT09cCl7IH0JLy8Jc3RyaXAgb2ZmIHRyYWlsaW5nIHBhZGRpbmcKCQlmb3IgKHZhciBpPTA7IGk8bDspewoJCQl2YXIgdD10YWIuaW5kZXhPZihzW2krK10pPDwxODsKCQkJaWYoaTw9bCl7IHR8PXRhYi5pbmRleE9mKHNbaSsrXSk8PDEyIH07CgkJCWlmKGk8PWwpeyB0fD10YWIuaW5kZXhPZihzW2krK10pPDw2IH07CgkJCWlmKGk8PWwpeyB0fD10YWIuaW5kZXhPZihzW2krK10pIH07CgkJCW91dC5wdXNoKCh0Pj4+MTYpJjB4ZmYpOwoJCQlvdXQucHVzaCgodD4+PjgpJjB4ZmYpOwoJCQlvdXQucHVzaCh0JjB4ZmYpOwoJCX0KCQkvLwlzdHJpcCBvZmYgYW55IG51bGwgYnl0ZXMKCQl3aGlsZShvdXRbb3V0Lmxlbmd0aC0xXT09MCl7IG91dC5wb3AoKTsgfQoJCXJldHVybiBvdXQ7CS8vCWJ5dGVbXQoJfQoKZnVuY3Rpb24gc3RyaW5nRnJvbUFycmF5KGRhdGEpCiAgewogICAgdmFyIGNvdW50ID0gZGF0YS5sZW5ndGg7CiAgICB2YXIgc3RyID0gIiI7CiAgICAKICAgIGZvcih2YXIgaW5kZXggPSAwOyBpbmRleCA8IGNvdW50OyBpbmRleCArPSAxKQogICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShkYXRhW2luZGV4XSk7CiAgICAKICAgIHJldHVybiBzdHI7CiAgfQoKZnVuY3Rpb24gbG9nUmVzcG9uc2UocmVzcG9uc2UpIHsKICAgIGxvZ2dlci53YXJuaW5nKCJPQl9Qb2xpY3kgVXNlciBSRVNUIENhbGwuIFN0YXR1czogIiArIHJlc3BvbnNlLmdldFN0YXR1cygpICsgIiwgQm9keTogIiArIHJlc3BvbnNlLmdldEVudGl0eSgpKTsKfQoKZnVuY3Rpb24gZ2V0SWRtQ2xpZW50RGV0YWlscygpIHsKICByZXR1cm4geyAKICAgICJpZCI6ICJwb2xpY3ktY2xpZW50IiwKICAgICJzZWNyZXQiOiAicGFzc3dvcmQiLAogICAgImVuZHBvaW50IjogImh0dHA6Ly9hbS9hbS9vYXV0aDIvYWNjZXNzX3Rva2VuIiwKICAgICJzY29wZSI6ICJmcjppZG06KiIKICB9Cn0KCmZ1bmN0aW9uIGdldElkbUFjY2Vzc1Rva2VuKCkgewoKICAgIHZhciBjbGllbnRJbmZvID0gZ2V0SWRtQ2xpZW50RGV0YWlscygpOwogICAgdmFyIHJlcXVlc3QgPSBuZXcgb3JnLmZvcmdlcm9jay5odHRwLnByb3RvY29sLlJlcXVlc3QoKTsKICAgIHJlcXVlc3Quc2V0VXJpKGNsaWVudEluZm8uZW5kcG9pbnQpOwogIAlyZXF1ZXN0LnNldE1ldGhvZCgiUE9TVCIpOwogICAgcmVxdWVzdC5nZXRIZWFkZXJzKCkuYWRkKCJDb250ZW50LVR5cGUiLCJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiKTsKICAgIHZhciBmb3JtdmFycyA9ICJncmFudF90eXBlPWNsaWVudF9jcmVkZW50aWFscyIgKwogICAgICAgICImY2xpZW50X2lkPSIgKyBjbGllbnRJbmZvLmlkICsKICAgICAgICAiJmNsaWVudF9zZWNyZXQ9IiArIGNsaWVudEluZm8uc2VjcmV0ICsKICAgICAgICAiJnNjb3BlPSIgKyBjbGllbnRJbmZvLnNjb3BlOwogICAgcmVxdWVzdC5zZXRFbnRpdHkoZm9ybXZhcnMpOwoKICAgIHZhciByZXNwb25zZSA9IGh0dHBDbGllbnQuc2VuZChyZXF1ZXN0KS5nZXQoKTsKICAgIGxvZ1Jlc3BvbnNlKHJlc3BvbnNlKTsKCiAgICB2YXIgb2F1dGgycmVzcG9uc2UgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmdldEVudGl0eSgpKTsKICAgIHZhciBhY2Nlc3NUb2tlbiA9IG9hdXRoMnJlc3BvbnNlLmFjY2Vzc190b2tlbgogICAgcmV0dXJuIGFjY2Vzc1Rva2VuCn0KCmZ1bmN0aW9uIGdldEludGVudChpbnRlbnRJZCxhcGkpIHsKICB2YXIgb2JqID0gbnVsbAogIAogIHN3aXRjaCAoYXBpKSB7CiAgICBjYXNlICJhY2NvdW50cyI6IAogICAgICBvYmogPSAiT2JBY2NvdW50QWNjZXNzIgogICAgICBicmVhazsKICAgIGNhc2UgImRvbWVzdGljLXBheW1lbnRzIjoKICAgICAgb2JqID0gIk9iRG9tZXN0aWNQYXltZW50IgogICAgICBicmVhazsKICB9CiAgIAogIHZhciBhY2Nlc3NUb2tlbiA9IGdldElkbUFjY2Vzc1Rva2VuKCk7CiAgdmFyIHJlcXVlc3QgPSBuZXcgb3JnLmZvcmdlcm9jay5odHRwLnByb3RvY29sLlJlcXVlc3QoKTsKICByZXF1ZXN0LnNldE1ldGhvZCgnR0VUJyk7CiAgcmVxdWVzdC5zZXRVcmkoImh0dHA6Ly9pZG0vb3BlbmlkbS9tYW5hZ2VkLyIgKyBvYmogKyAiLyIgKyBpbnRlbnRJZCkKICByZXF1ZXN0LmdldEhlYWRlcnMoKS5hZGQoIkF1dGhvcml6YXRpb24iLCJCZWFyZXIgIiArIGFjY2Vzc1Rva2VuKTsKCiAgdmFyIHJlc3BvbnNlID0gaHR0cENsaWVudC5zZW5kKHJlcXVlc3QpLmdldCgpOwogIGxvZ1Jlc3BvbnNlKHJlc3BvbnNlKTsKCiAgdmFyIGludGVudCA9IEpTT04ucGFyc2UocmVzcG9uc2UuZ2V0RW50aXR5KCkpOwogIHJldHVybiBpbnRlbnQKfQoKZnVuY3Rpb24gZGF0YUF1dGhvcmlzZWQocGVybWlzc2lvbnMsZGF0YVJlcXVlc3QpIHsKICBzd2l0Y2ggKGRhdGFSZXF1ZXN0KSB7CiAgICBjYXNlICJiYWxhbmNlcyI6CiAgICAgIGF1dGhvcmlzZWQgPSAocGVybWlzc2lvbnMuaW5kZXhPZigiUmVhZEJhbGFuY2VzIikgPiAtMSk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAidHJhbnNhY3Rpb25zIjoKICAgICAgYXV0aG9yaXNlZCA9IChwZXJtaXNzaW9ucy5pbmRleE9mKCJSZWFkVHJhbnNhY3Rpb25zRGV0YWlsIikgPiAtMSk7CiAgICAgIGJyZWFrCiAgICBkZWZhdWx0OgogICAgICBhdXRob3Jpc2VkID0gZmFsc2UKICAgICAgCiAgfQogIAogIHJldHVybiBhdXRob3Jpc2VkCn0KCmZ1bmN0aW9uIGluaXRpYXRpb25NYXRjaChpbml0aWF0aW9uUmVxdWVzdCxpbml0aWF0aW9uKSB7CiAgCiAgLy8gVE9ETzogcHJvYmFibHkgaGF2ZSB0byBtYWtlIHRoaXMgbW9yZSByb2J1c3QgLSBpLmUuIG5vdCBvcmRlciBkZXBlbmRlbnQgZXRjCiAgCiAgdmFyIHIgPSBKU09OLnN0cmluZ2lmeShpbml0aWF0aW9uKQogIHZhciBvID0gc3RyaW5nRnJvbUFycmF5KGJhc2U2NGRlY29kZShpbml0aWF0aW9uUmVxdWVzdCkpIAogIAogIGxvZ2dlci5tZXNzYWdlKCJPQl9Qb2xpY3kgcmVxdWVzdCAgWyIgKyAgciArICJdIik7CiAgbG9nZ2VyLm1lc3NhZ2UoIk9CX1BvbGljeSBvcmlnaW5hbCBbIiArICBvICsgIl0iKTsKICAKICAKICByZXR1cm4gKHIgPT0gbyk7ICAgICAgICAgICAgIAp9Cgp2YXIgaW50ZW50SWQgPSBlbnZpcm9ubWVudC5nZXQoImludGVudF9pZCIpLml0ZXJhdG9yKCkubmV4dCgpOwoKdmFyIGFwaVJlcXVlc3QgPSBwYXJzZVJlc291cmNlVXJpKCkKCmxvZ2dlci53YXJuaW5nKCJPQl9Qb2xpY3kgcmVxICIgKyBhcGlSZXF1ZXN0LmFwaSArICI6IiArIGFwaVJlcXVlc3QuYWNjb3VudCArICI6IiArIGFwaVJlcXVlc3QuZGF0YSk7CiAgICAgICAgICAgICAgIAp2YXIgaW50ZW50ID0gZ2V0SW50ZW50KGludGVudElkLGFwaVJlcXVlc3QuYXBpKTsKCmlmIChhcGlSZXF1ZXN0LmFwaSA9PSAiYWNjb3VudHMiKSB7CgogIHZhciBzdGF0dXMgPSBpbnRlbnQuRGF0YS5TdGF0dXMKICB2YXIgcGVybWlzc2lvbnMgPSBpbnRlbnQuRGF0YS5QZXJtaXNzaW9ucwogIHZhciBhY2NvdW50cyA9IGludGVudC5BY2NvdW50cwoKICBpZiAoc3RhdHVzICE9IFNUQVRVU19BVVRIT1JJU0VEKSB7CiAgICBsb2dnZXIud2FybmluZygiUmVqZWN0aW5nIHJlcXVlc3QgLSBzdGF0dXMgWyIgKyBzdGF0dXMgKyAiXSIpCiAgICBhdXRob3JpemVkID0gZmFsc2UKICAgIAogIH0KICBlbHNlIGlmIChhcGlSZXF1ZXN0LmFjY291bnQgPT0gbnVsbCkgewogICAgbG9nZ2VyLm1lc3NhZ2UoIk9CX1BPTElDWSBhY2NvdW50cyAiICsgYWNjb3VudHMpOwogICAgcmVzcG9uc2VBdHRyaWJ1dGVzLnB1dCgiZ3JhbnRlZEFjY291bnRzIixhY2NvdW50cykKICAgIGF1dGhvcml6ZWQgPSB0cnVlCiAgfQogIGVsc2UgaWYgKGFwaVJlcXVlc3QuZGF0YSA9PSBudWxsKSB7CiAgICBsb2dnZXIubWVzc2FnZSgiT0JfUE9MSUNZIGFjY291bnQgaW5mbyBmb3IgIiArIGFwaVJlcXVlc3QuYWNjb3VudCk7CiAgICBhdXRob3JpemVkID0gKGFjY291bnRzLmluZGV4T2YoYXBpUmVxdWVzdC5hY2NvdW50KSA+IC0xKSAmJgogICAgICAgICAgICAgICAgIChwZXJtaXNzaW9ucy5pbmRleE9mKCJSZWFkQWNjb3VudHNEZXRhaWwiKSA+IC0xKQogIH0KICBlbHNlIHsKICAgIGxvZ2dlci5tZXNzYWdlKCJPQl9QT0xJQ1kgYWNjb3VudCByZXF1ZXN0IGZvciAiICsgYXBpUmVxdWVzdC5hY2NvdW50ICsgIjoiICsgYXBpUmVxdWVzdC5kYXRhKTsKICAgIGF1dGhvcml6ZWQgPSAoYWNjb3VudHMuaW5kZXhPZihhcGlSZXF1ZXN0LmFjY291bnQpID4gLTEpICYmIAogICAgICAgICAgICAgICAgIGRhdGFBdXRob3Jpc2VkKHBlcm1pc3Npb25zLGFwaVJlcXVlc3QuZGF0YSkKICB9CiAgCn0KZWxzZSBpZiAoYXBpUmVxdWVzdC5hcGkgPT0gImRvbWVzdGljLXBheW1lbnRzIikgewogIAogIHZhciBzdGF0dXMgPSBpbnRlbnQuRGF0YS5TdGF0dXMKICB2YXIgcGVybWlzc2lvbnMgPSBpbnRlbnQuRGF0YS5QZXJtaXNzaW9ucwogIHZhciBhY2NvdW50cyA9IGludGVudC5BY2NvdW50cwoKICBpZiAoc3RhdHVzICE9IFNUQVRVU19BVVRIT1JJU0VEKSB7CiAgICBsb2dnZXIud2FybmluZygiUmVqZWN0aW5nIHJlcXVlc3QgLSBzdGF0dXMgWyIgKyBzdGF0dXMgKyAiXSIpCiAgICBhdXRob3JpemVkID0gZmFsc2UKICAgIAogIH0KICBlbHNlIHsKICAgIGF1dGhvcml6ZWQgPSBpbml0aWF0aW9uTWF0Y2goZW52aXJvbm1lbnQuZ2V0KCJpbml0aWF0aW9uIikuaXRlcmF0b3IoKS5uZXh0KCksaW50ZW50LkRhdGEuSW5pdGlhdGlvbikKICB9CiAgCn0KZWxzZSB7CiAgYXV0aG9yaXplZCA9IGZhbHNlCn0="
  }
}